name: Deploy to Cloudflare

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Generate wrangler.toml from secrets
        run: |
          cat > wrangler.toml <<'EOF'
          name = "${{ secrets.WRANGLER_NAME || 'nav-site' }}"
          main = "worker.js"
          compatibility_date = "${{ secrets.COMPAT_DATE || '2024-01-01' }}"

          assets = { directory = "./public", binding = "ASSETS" }

          [[d1_databases]]
          binding = "DB"
          database_name = "${{ secrets.D1_NAME || 'nav_db' }}"
          database_id = "${{ secrets.CF_DATABASE_ID }}"

          [[kv_namespaces]]
          binding = "BG"
          id = "${{ secrets.CF_KV_ID }}"
          EOF

      - name: Install Wrangler
        run: npm install wrangler --save-dev

      - name: Init D1 schema (idempotent)
        run: |
          DB_NAME="${D1_NAME:-nav_db}"
          npx wrangler d1 execute "$DB_NAME" --file=schema.sql
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          D1_NAME: ${{ secrets.D1_NAME }}

      - name: Deploy to Cloudflare Workers
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}